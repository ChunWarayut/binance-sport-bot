<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Spot Trading Bot - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #4a9eff;
            font-size: 24px;
        }

        .status {
            padding: 8px 16px;
            border-radius: 5px;
            font-weight: 600;
        }

        .status.connected {
            background: #10b981;
            color: white;
        }

        .status.disconnected {
            background: #ef4444;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1a1f3a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            color: #4a9eff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #2a2f4a;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #9ca3af;
        }

        .metric-value {
            font-weight: 600;
            font-size: 16px;
        }

        .positive {
            color: #10b981;
        }

        .negative {
            color: #ef4444;
        }

        .table-container {
            background: #1a1f3a;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #2a2f4a;
        }

        th {
            color: #4a9eff;
            font-weight: 600;
        }

        tr:hover {
            background: #252a4a;
        }

        .btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #3a8eef;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #df3333;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #9ca3af;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #1a1f3a;
            border: none;
            border-radius: 5px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #4a9eff;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ¦Š Binance Spot Trading Bot</h1>
            <div class="status disconnected" id="status">Disconnected</div>
        </header>

        <div class="grid">
            <div class="card">
                <h2>Portfolio Summary</h2>
                <div class="loading" id="portfolioLoading">Loading...</div>
                <div id="portfolioContent" style="display: none;">
                    <div class="metric">
                        <span class="metric-label">Total Value</span>
                        <span class="metric-value" id="totalValue">$0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Open Positions</span>
                        <span class="metric-value" id="openPositions">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">USDT Balance</span>
                        <span class="metric-value" id="usdtBalance">0</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Performance (30 days)</h2>
                <div class="loading" id="performanceLoading">Loading...</div>
                <div id="performanceContent" style="display: none;">
                    <div class="metric">
                        <span class="metric-label">Total PnL</span>
                        <span class="metric-value" id="totalPnL">$0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Win Rate</span>
                        <span class="metric-value" id="winRate">0%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Trades</span>
                        <span class="metric-value" id="totalTrades">0</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Active Strategies</h2>
                <div class="loading" id="strategiesLoading">Loading...</div>
                <div id="strategiesContent" style="display: none;">
                    <div class="metric">
                        <span class="metric-label">Total Strategies</span>
                        <span class="metric-value" id="totalStrategies">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Active</span>
                        <span class="metric-value" id="activeStrategies">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('positions')">Open Positions</button>
            <button class="tab" onclick="showTab('trades')">Recent Trades</button>
            <button class="tab" onclick="showTab('strategies')">Strategies</button>
        </div>

        <div id="positionsTab" class="tab-content active">
            <div class="table-container">
                <h2>Open Positions</h2>
                <div class="loading" id="positionsLoading">Loading...</div>
                <table id="positionsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Quantity</th>
                            <th>Entry Price</th>
                            <th>Current Price</th>
                            <th>PnL</th>
                            <th>PnL %</th>
                        </tr>
                    </thead>
                    <tbody id="positionsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tradesTab" class="tab-content">
            <div class="table-container">
                <h2>Recent Trades</h2>
                <div class="loading" id="tradesLoading">Loading...</div>
                <table id="tradesTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>PnL</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="tradesBody"></tbody>
                </table>
            </div>
        </div>

        <div id="strategiesTab" class="tab-content">
            <div class="table-container">
                <h2>Strategies</h2>
                <div class="loading" id="strategiesListLoading">Loading...</div>
                <table id="strategiesListTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Symbol</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="strategiesListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;

        // Check connection status
        async function checkConnection() {
            try {
                const response = await fetch(`${API_URL}/`);
                const statusEl = document.getElementById('status');
                if (response.ok) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'status connected';
                } else {
                    statusEl.textContent = 'Disconnected';
                    statusEl.className = 'status disconnected';
                }
            } catch (error) {
                document.getElementById('status').textContent = 'Disconnected';
                document.getElementById('status').className = 'status disconnected';
            }
        }

        // Load portfolio
        async function loadPortfolio() {
            try {
                // Add timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                
                const response = await fetch(`${API_URL}/api/portfolio`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                document.getElementById('portfolioLoading').style.display = 'none';
                document.getElementById('portfolioContent').style.display = 'block';
                
                if (data.success && data.data) {
                    document.getElementById('totalValue').textContent = `$${(data.data.totalValue || 0).toFixed(2)}`;
                    document.getElementById('openPositions').textContent = data.data.openPositions || 0;
                    
                    const usdtBalance = data.data.balances?.find(b => b.asset === 'USDT');
                    document.getElementById('usdtBalance').textContent = usdtBalance ? usdtBalance.total.toFixed(2) : '0.00';
                } else {
                    // Show error state
                    document.getElementById('totalValue').textContent = '$0.00';
                    document.getElementById('openPositions').textContent = '0';
                    document.getElementById('usdtBalance').textContent = '0.00';
                    if (data.error) {
                        console.warn('Portfolio API error:', data.error);
                    }
                }
            } catch (error) {
                console.error('Error loading portfolio:', error);
                document.getElementById('portfolioLoading').style.display = 'none';
                document.getElementById('portfolioContent').style.display = 'block';
                document.getElementById('totalValue').textContent = '$0.00';
                document.getElementById('openPositions').textContent = '0';
                document.getElementById('usdtBalance').textContent = '0.00';
            }
        }

        // Load performance
        async function loadPerformance() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${API_URL}/api/performance`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                document.getElementById('performanceLoading').style.display = 'none';
                document.getElementById('performanceContent').style.display = 'block';
                
                if (data.success && data.data) {
                    const pnl = parseFloat(data.data.totalPnL || '0');
                    document.getElementById('totalPnL').textContent = `$${pnl.toFixed(2)}`;
                    document.getElementById('totalPnL').className = `metric-value ${pnl >= 0 ? 'positive' : 'negative'}`;
                    
                    document.getElementById('winRate').textContent = `${data.data.winRate || '0.00'}%`;
                    document.getElementById('totalTrades').textContent = data.data.totalTrades || 0;
                } else {
                    document.getElementById('totalPnL').textContent = '$0.00';
                    document.getElementById('winRate').textContent = '0.00%';
                    document.getElementById('totalTrades').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading performance:', error);
                document.getElementById('performanceLoading').style.display = 'none';
                document.getElementById('performanceContent').style.display = 'block';
                document.getElementById('totalPnL').textContent = '$0.00';
                document.getElementById('winRate').textContent = '0.00%';
                document.getElementById('totalTrades').textContent = '0';
            }
        }

        // Load strategies summary
        async function loadStrategies() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${API_URL}/api/strategies`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                document.getElementById('strategiesLoading').style.display = 'none';
                document.getElementById('strategiesContent').style.display = 'block';
                
                if (data.success && data.data) {
                    const total = data.data.length || 0;
                    const active = data.data.filter(s => s.isActive).length || 0;
                    
                    document.getElementById('totalStrategies').textContent = total;
                    document.getElementById('activeStrategies').textContent = active;
                } else {
                    document.getElementById('totalStrategies').textContent = '0';
                    document.getElementById('activeStrategies').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading strategies:', error);
                document.getElementById('strategiesLoading').style.display = 'none';
                document.getElementById('strategiesContent').style.display = 'block';
                document.getElementById('totalStrategies').textContent = '0';
                document.getElementById('activeStrategies').textContent = '0';
            }
        }

        // Load positions
        async function loadPositions() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${API_URL}/api/positions/open`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                document.getElementById('positionsLoading').style.display = 'none';
                document.getElementById('positionsTable').style.display = 'table';
                
                const tbody = document.getElementById('positionsBody');
                tbody.innerHTML = '';
                
                if (data.success && data.data && data.data.length > 0) {
                    data.data.forEach(position => {
                        const pnl = parseFloat(position.unrealizedPnl || '0');
                        const pnlPercent = parseFloat(position.unrealizedPnlPercent || '0');
                        
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${position.symbol}</td>
                            <td>${position.side}</td>
                            <td>${parseFloat(position.quantity).toFixed(6)}</td>
                            <td>$${parseFloat(position.entryPrice).toFixed(2)}</td>
                            <td>$${parseFloat(position.currentPrice || position.entryPrice).toFixed(2)}</td>
                            <td class="${pnl >= 0 ? 'positive' : 'negative'}">$${pnl.toFixed(2)}</td>
                            <td class="${pnlPercent >= 0 ? 'positive' : 'negative'}">${pnlPercent.toFixed(2)}%</td>
                        `;
                    });
                } else {
                    // Show empty message
                    const row = tbody.insertRow();
                    row.innerHTML = '<td colspan="7" style="text-align: center; color: #9ca3af;">No open positions</td>';
                }
            } catch (error) {
                console.error('Error loading positions:', error);
                document.getElementById('positionsLoading').style.display = 'none';
                document.getElementById('positionsTable').style.display = 'table';
                const tbody = document.getElementById('positionsBody');
                tbody.innerHTML = '<td colspan="7" style="text-align: center; color: #ef4444;">Error loading positions</td>';
            }
        }

        // Load trades
        async function loadTrades() {
            try {
                const response = await fetch(`${API_URL}/api/trades?limit=20`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('tradesLoading').style.display = 'none';
                    document.getElementById('tradesTable').style.display = 'table';
                    
                    const tbody = document.getElementById('tradesBody');
                    tbody.innerHTML = '';
                    
                    data.data.forEach(trade => {
                        const pnl = parseFloat(trade.pnl || '0');
                        const date = new Date(trade.executedAt);
                        
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${trade.symbol}</td>
                            <td>${trade.side}</td>
                            <td>${parseFloat(trade.quantity).toFixed(6)}</td>
                            <td>$${parseFloat(trade.price).toFixed(2)}</td>
                            <td class="${pnl >= 0 ? 'positive' : 'negative'}">$${pnl.toFixed(2)}</td>
                            <td>${date.toLocaleString()}</td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }

        // Load strategies list
        async function loadStrategiesList() {
            try {
                const response = await fetch(`${API_URL}/api/strategies`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('strategiesListLoading').style.display = 'none';
                    document.getElementById('strategiesListTable').style.display = 'table';
                    
                    const tbody = document.getElementById('strategiesListBody');
                    tbody.innerHTML = '';
                    
                    data.data.forEach(strategy => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${strategy.name}</td>
                            <td>${strategy.type}</td>
                            <td>${strategy.symbol || 'Auto'}</td>
                            <td>${strategy.isActive ? '<span class="positive">Active</span>' : '<span class="negative">Inactive</span>'}</td>
                            <td>
                                <button class="btn" onclick="toggleStrategy('${strategy.id}', ${!strategy.isActive})">
                                    ${strategy.isActive ? 'Stop' : 'Start'}
                                </button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error loading strategies list:', error);
            }
        }

        async function toggleStrategy(id, start) {
            try {
                const endpoint = start ? 'start' : 'stop';
                const response = await fetch(`${API_URL}/api/strategies/${id}/${endpoint}`, {
                    method: 'POST',
                });
                
                if (response.ok) {
                    loadStrategiesList();
                    loadStrategies();
                }
            } catch (error) {
                console.error('Error toggling strategy:', error);
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}Tab`).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for tab
            if (tabName === 'positions') {
                loadPositions();
            } else if (tabName === 'trades') {
                loadTrades();
            } else if (tabName === 'strategies') {
                loadStrategiesList();
            }
        }

        // Initial load
        checkConnection();
        loadPortfolio();
        loadPerformance();
        loadStrategies();
        loadPositions();

        // Refresh every 30 seconds
        setInterval(() => {
            checkConnection();
            loadPortfolio();
            loadPerformance();
            loadStrategies();
            
            if (document.getElementById('positionsTab').classList.contains('active')) {
                loadPositions();
            } else if (document.getElementById('tradesTab').classList.contains('active')) {
                loadTrades();
            } else if (document.getElementById('strategiesTab').classList.contains('active')) {
                loadStrategiesList();
            }
        }, 30000);
    </script>
</body>
</html>
